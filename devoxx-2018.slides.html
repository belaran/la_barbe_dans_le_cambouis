<!DOCTYPE html>
<html>
  <head>
    <title>Title</title>
    <meta charset="utf-8">
    <style>
      @import url(https://fonts.googleapis.com/css?family=Yanone+Kaffeesatz);
      @import url(https://fonts.googleapis.com/css?family=Droid+Serif:400,700,400italic);
      @import url(https://fonts.googleapis.com/css?family=Ubuntu+Mono:400,700,400italic);

      body { font-family: 'Droid Serif'; }
      h1, h2, h3 {
        font-family: 'Yanone Kaffeesatz';
        font-weight: normal;
      }
      .remark-code, .remark-inline-code { font-family: 'Ubuntu Mono'; }
      .big-list { font-size:200%; }
      .bigger-list { font-size: 280%; }
    </style>
  </head>
  <body>
    <textarea id="source">

class: center, middle

# La Barbe dans le cambouis : Sécurisons une bonne vieille application Java "Entreprise"

François Le Droff - injecte plein de DRMs sur vos machines pour Adobe

Romain Pelisse - fix des bogues sur les APIs de nos grand parents pour Red Hat

---

# Agenda

(genre, on sait ce qu'on fait...)

* prérequis
* lab1 - notre application ("build and deploy")
* lab2 - mise en place d'une solution d'identity
* lab3 - mise en place et sécurisation de Swagger
* lab4 - mise en place d'un reverse-proxy filtrant
* lab5 - mise en place du chiffrement SSL
* lab6 - intégration avec Sprint Security
* lab7 - base de données - chiffrement et connexion sécurisée
* lab8 - protéger le système de l'application avec le Security Manager et SELinux
* lab9 - intégrité du fichier du contenu du fichier de journalisation

---
# Prérequis

* Java - JDK installé, son IDE préféré, et maven
* Docker - docker et docker-compose installé, plus la 'registry' suivante:
* TODO
* Systèmes d'exploitation:
* Linux: Desactiver SELinux
* MacOS: Demerdez vous, bande hipster
* Windows: Not an OS, réinstaller un Linux

---

# Une bonne vielle app Java...

.center[!["Cool" App](img/vt100.jpg)]

---

# Lab1 - Construire et démarrer le micro -service

* TODO: Spring Boot en qql mots
* TODO: la app en qql mots
* git clone from... (tag!)
* 'cd' into 'danslecambouis'
* $ mvnw compile (erreur)
* implémenter le corps de la méthode 'ping'
* $ mvn compile
* $ mvn spring-boot:run
* tester avec $ curl http://localhost:9080/ping

Exercice supplémentaire: TODO

---

# Lab2 - Démarrer Keycloak

* Keycloak en qql mots
* docker-compose -f src/main/docker/keycloak up
* vérifier en vous connectant sur http://(ip-keycloak)/
* cred: admin/admin

* retrouver l'IP attribué par Docker: $ docker ps -q | xargs docker inspect --format '{{ .Id }} - {{ .Name }} - {{ .NetworkSettings.IPAddress }}'

---
# Lab2 - Définir de notre royaume de sécurité

* capture d'écran FLD

---
# Lab2 - Tester la mise en place du royaume de sécurité

* connectez vous avec le user crée
* en admin faites expirer la session de cet utilisateur

---
# Lab2 - Mettre en place l'authentification à l'aide Keycloak

* git clone ... / tag
* modifier la configuration fournises dans application.properties pour fonctionner avec votre instance keycloak

* Pour les plus avancés... Utiliser Spring Security, plutôt que le fichier application.properties pour intégrer Keycloak.

---
# Lab3 - Mise en place de Swagger

* recopier les instructions du README ici?

### swagger

Explore our API documentation at
* browse to http://localhost:9091/swagger-ui.html

---
# Lab4 - Mise en place d'un serveur inverse filtrant avec Nginx


* $ docker -f src/main/docker/nginx.yml up
* modifier la configuration fournises pour rediriger proprement vers votre service:
* (editer le fichier src/main/docker/nginx-config/basic-rp.conf)
* tester avec curl http://(ip-du-conteneur)/ping
* ajouter une redirection pour aussi "masquer" keycloak derrière ce proxy
* modifier en conséquence la configuration de votre service
* et celle de Keycloak
* interdiser les requêtes POST, DELETE, HEAD et PUT en direction de /ping
* de la même manière, limiter les requêtes vers Swagger au strict minimum
* configurer nginx pour refuser les requêtes vers /ping contenant des paramètres
* configurer nginx pour refuser les requêtes vers /swagger-ui* à part /swagger-ui.html, n'autoriser que les GET, retirer les arguments des requêtes.

---
# Lab5 - Mise en place du chiffrement SSL devant /ping et swagger

* git ... (tag)
* corriger la configuration fourni
* générer les certificats nécessaires et ajoute le volume associé
* tester que SSL fonctionne (https://localhost/)
* tester que /ping and /account sont toujours accessible via https
* incident: revoquer le certificat et le remplacer par un nouveau

TODO: https://www.digitalocean.com/community/tutorials/how-to-create-a-self-signed-ssl-certificate-for-nginx-on-centos-7

---
# Lab6 - Intégration avec Spring Security

* Frameworking your way out of security...

.center[![Spring Security Logo](img/spring-security.logo.png)]

* (... because we can't gradle the shit out of it)

---
# Lab6 - Mise en place de Spring Security

* ajouter Spring Security aux dépendances du projet
* ajouter la configuration d'un connecteur Keycloak pour Spring Security
* migrer la configuration de KeyCloak du application.properties dans une classe qui étend KeycloakWebSecurityConfigurerAdapter
* Tester et vérifier que l'intégration avec Keycloak fonctionne toujours sans encombre

* Ref: <a href="https://developers.redhat.com/blog/2017/05/25/easily-secure-your-spring-boot-applications-with-keycloak/">Spring Boot with Keycloak</a>

---
# Lab6 - CSRF et Cache control

* Vérifier le bon fonctionnement de l'API '/stuff' fournise (git clone [tag])
* Mettre en place la protection contre le <a href="https://docs.spring.io/spring-security/site/docs/current/reference/html/csrf.html">CSRF</a> et la <a href="https://docs.spring.io/spring-security/site/docs/current/reference/html/headers.html#headers-cache-control">gestion du cache</a> à l'aide de Spring Security
* Vérifier le bon fonctionnement de ces configurations à l'aide des requêtes curl suivante:

    curl -v http://localhost:9091/stuff
    curl -v -H "Content-Type: application/json" -X POST -d '{"title":"un titre","text":"du texte"}' http://localhost:9091/stuff
    curl -v -H "Content-Type: application/json" -X DELETE -d '{"title":"un titre","text":"du texte"}' http://localhost:9091/stuff

* Vérifier que les messages de retour sont cohérent avec les attentes:

    {"timestamp":1523630530507,"status":403,"error":"Forbidden","message":"Could not verify the provided CSRF token because your session was not found.","path":"/stuff"}

* Vérifier la présence des nombreux entêtes de sécurité ajoutés par Spring Security:

       Cache-Control: no-cache, no-store, max-age=0, must-revalidate
       Pragma: no-cache
       Expires: 0

       X-Content-Type-Options: nosniff

       Strict-Transport-Security: max-age=31536000 ; includeSubDomains
       X-Frame-Options: DENY
       X-XSS-Protection: 1; mode=block

---
# Lab7 - Base de données

TODO:
* mise en place de MongoDB
* connexion sécurisée (SSL)
* chiffrement des données

---
# Lab7 - Le "Security Manager" (par configuration)

* Le Java Sécurity Manager en quelques mots... et un jolie (?) dessin

.center[![Java Security Manager Architecture](img/security-manager.png)]

---
# Lab8 - Le "Security Manager" (par configuration)

* Démarrer votre service en activant le système manager (sans configuration, "deny all"):
*   $ java ... -Djava.security.manager -Djava.security.policy=file:///no.policy
* Note: si le fichier no.policy n'existe pas (ou est vide), aucune autorisation donnée à l'applicatif!!!
* Avec Spring Boot:
.center[![Java Security Manager + Spring Boot](img/springboot-with-secman.png)]

---
# Lab8 - Le "Security Manager" (par configuration)

* Modifier la configuration suivante pour permettre le démarrage du service avec le securité manager
<pre>
<code>
grant {
&nbsp;&nbsp;&nbsp;permission java.util.PropertyPermission  "*", "read, write";
&nbsp;&nbsp;&nbsp;permission java.util.PropertyPermission "java.awt.headless", "read";
&nbsp;&nbsp;&nbsp;permission java.io.FilePermission
&nbsp;&nbsp;&nbsp;&nbsp;"[path-to]/devoxx-france-lab-2018.git/danslecambouis", "read";
&nbsp;&nbsp;&nbsp;permission java.lang.reflect.ReflectPermission "*";
};
</code>
</pre>
---
# Lab8 - Le "Security Manager" (version programmatique)

* "Ca marche pas!" et ça peut demander <a href="http://blog.sevagas.com/?Enable-securitymanager-for-Spring-and-Hibernate">beaucoup de boulot</a>.
* C'est l'enfer, hein? Bon faisons autrement...
* Créer votre propre SecurityManager!
<pre>
<code>
public class PingSecurityManager extends SecurityManager {
...}
</pre>
</code>
* Et injecte le dans votre application:
<pre>
<code>
if ( System.getSecurityManager() == null )
			System.setSecurityManager(new PingSecurityManager());
</code>
</pre>
* Surcharger les méthodes checkPermission (vide) pour autoriser l'app a accéder aux properties
* Surcharger la méthode checkAccept pour autoriser le démarrage du serveur

---
# Lab8 - Le "Sécurity Manager" (version programmatique)

* Ajouter les méthodes nécessaires pour autoriser l'accès à la base de données

* Exo Avancé: implémenter  checkPermission pour n'autoriser que les accès aux propriétés nécessaires

---
# Lab8 - Aller plus loin... SELinux

* SELinux en quelques mots... (<a href="https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/7/html/selinux_users_and_administrators_guide/index">Docs</a>)
.center[![](img/selinux-arch.png)]

* Tutorial SELinux (<a href="https://www.digitalocean.com/community/tutorials/an-introduction-to-selinux-on-centos-7-part-1-basic-concepts">Part 1</a> et <a href="https://www.digitalocean.com/community/tutorials/an-introduction-to-selinux-on-centos-7-part-2-files-and-processes">Part 2</a>)

* Objectif: Créer un utilisateur 'pingservice' appartenant au group 'microservices'
confiner à /ping (volume monté, mappé sur la racine du projet)

---
# Lab8 -  Aller plus loin... SELinux

* Modifier l'utilisateur pour l'associer à
* $ semanage login -a -s user_u pingservice

---
# Lab9 - Pour aller plus loin...

* une attaque peut changer le contenu du fichier de journalisation (valide pour SELinux/SecurityManager)
* ajout d'un checksum pour assurer que le contenu du fichier est correct

---
# Conclusion

* It was fun! (we hope)
* You learn stuff! (we hope)
* Your laptop still works (hopefully)
    </textarea>
    <script src="https://remarkjs.com/downloads/remark-latest.min.js">
    </script>
    <script>
      var slideshow = remark.create();
    </script>
  </body>
</html>
