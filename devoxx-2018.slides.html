<!DOCTYPE html>
<html>
  <head>
    <title>Title</title>
    <meta charset="utf-8">
    <style>
      @import url(https://fonts.googleapis.com/css?family=Yanone+Kaffeesatz);
      @import url(https://fonts.googleapis.com/css?family=Droid+Serif:400,700,400italic);
      @import url(https://fonts.googleapis.com/css?family=Ubuntu+Mono:400,700,400italic);

      body { font-family: 'Droid Serif'; }
      h1, h2, h3 {
        font-family: 'Yanone Kaffeesatz';
        font-weight: normal;
      }
      .remark-code, .remark-inline-code { font-size:80%; font-family:Courier; background-color: #FFFFE0}
      .big-list { font-size:200%; }
      .bigger-list { font-size: 280%; }
      .timer { text-align:right; font-style: italic; font-size: 200%; height: 50px; }
      .upper-right-corner {  text-align:right; }
      .console { font-family:Courier;
                 color: #CCCCCC;
                 background: #000000;
                 border: 3px double #CCCCCC;
                 padding: 10px;
      }
      .source-code {
          font-family: Courier;
          color: black;
          background: #ffffcc;
          border: 1px black;
      }
      .aller-plus-loin {
          background: #EAEDED;
          border: 2px solid black;
          padding: 15px;
      }
      .aller-plus-loin-titre {
          font-weight : bold;
      }
    </style>
  </head>
  <body>
    <textarea id="source">

class: center, middle

## La Barbe dans le cambouis
# Sécurisons une bonne vieille application Java "Entreprise"

`François Le Droff` - un des plombiers derrière `adobe.io`

`Romain Pelisse` - corrige des bogues sur les APIs de nos grand parents pour `RedHat`

---

# Agenda


* Prérequis
* lab1 - notre application ("build and deploy")
* lab2 - mise en place d'une solution d'identity
* lab3 - mise en place et sécurisation de Swagger
* lab4 - mise en place d'un reverse-proxy filtrant
* lab5 - mise en place du chiffrement SSL
* lab6 - intégration avec Sprint Security
* lab7 - base de données - chiffrement et connexion sécurisée
* lab8 - protéger le système de l'application avec le Security Manager et SELinux
* lab9 - intégrité du fichier du contenu du fichier de journalisation

---
# Prérequis

* Systèmes d'exploitation:
  * Linux: bien sûr, désactiver `SELinux`
  * MacOS: Démerdez vous, bande d'hipster
  * Windows: Merci d'installer un vrai OS
    * ou a minima faites en sorte d'avoir un `bash (unix shell)` à disposition

* Outillage:
  * Installez Java - JDK 8 (nous avons testé le lab avec la version `1.8.0_162-b12` et `openjdk version "1.8.0_161`)
  * Venez avec votre IDE/`vi` préféré, peu nous importe ;)
  * Installez Maven (nous avons testé le lab avec `Apache Maven 3.3.9` et `Apache Maven 3.5.0 (Red Hat 3.5.0-6)`)
  * Installez docker (nous avons testé la version `18.04.0-ce-rc2` et `1.13.1, build caba767-unsupported`)
  * Installez docker-compose (nous avons testé la version `1.20.1` et `1.17.1, build 6d101fb`)


---

# Prérequis

Pour plus de comfort durant le lab et ne pas souffir des aléas du réseau du palais des congrès, lancer les commandes suivantes à l'avance:

  * Clonez notre repo git
    * `git clone https://github.com/francoisledroff/la_barbe_dans_le_cambouis.git`
    * `cd la_barbe_dans_le_cambouis`
  * Un peu de Docker ensuite:
    * `docker-compose -f src/main/docker/keycloak.yml up`
    * `src/main/docker/build-docker-image.sh`
    * `docker build -t mongo src/main/docker/mongo/`
  * et enfin construisez notre bonne vieille application Java (et télecharger internet pour satisfaire maven)
    * `mvnw clean install`

---

# Une bonne vielle application Java...

.center[!["Cool" App](img/vt100.jpg)]

---
<div class="upper-right-corner"><img src="img/spring-boot.png" height="50px"/></div>

# Spring Boot

Spring Boot permet de créer facilement des applications Spring avec `peu` de configuration.

Fonctionalités:
* Crée des applications Spring autonomes
* Intégre directement Tomcat, Jetty ou Undertow (pas besoin de déployer des fichiers WAR)
* Fournit des POM «starter» orientées pour simplifier votre configuration Maven
* Aucune génération de code et aucune exigence pour la configuration XML

<center><a href=">https://projects.spring.io/spring-boot/">https://projects.spring.io/spring-boot/</a></center>

---

# Lab1 - Construire et démarrer le micro -service
<div class="timer">15' <img src="img/chronometer.png" height="50px"/></div>
<pre class="console">
$ git clone from... (tag!)
$ 'cd' into 'danslecambouis'
$ mvnw compile (erreur)
</pre>

* implémenter le corps de la méthode 'ping' puis exécuter et tester le service

<pre class="console">
$ mvn spring-boot:run
$ curl http://localhost:9080/ping
</pre>
---
# Lab1 - Construire et démarrer le micro -service

<div class="aller-plus-loin">
<span class="aller-plus-loin-titre">Pour aller plus loin...</span>
<ul>
  <li>Modifier '/ping' pour accepter un paramètre (hostname)</li>
  <li>et exécuter un 'ping' (OS) sur le nom de domaine fourni en argument</li>
  <li>et retourner le temps de réponse du premier ping ("[hostname]: 20ms").</li>
</ul>
</div>
---

<div class="upper-right-corner"><img src="img/keycloak.png" height="80px"/></div>

# Keycloak

Solution Open Source de gestion de l'identité et d'accès
Plus besoin de gérer le stockage des utilisateurs ou l'authentification des utilisateurs.

* SSO Authentification unique: Connectez-vous une fois pour plusieurs applications
* Protocoles standards: OpenID Connect, OAuth 2.0 et SAML 2.0
* LDAP et Active Directory: Connectez-vous aux répertoires d'utilisateurs existants
* Connexion sociale
* Courtage d'identité: OpenID Connect ou les fournisseurs d'identité SAML 2.0
* Clustering
* Thèmes: Personnalisez l'aspect et la convivialité
* Extensible: codez !
* Mot de passe: Personnalisez les règles de mot de passe

<center><a href="https://www.keycloak.org/">https://www.keycloak.org/</a></center>

---

# Lab2 - Démarrer Keycloak
<div class="timer">20' <img src="img/chronometer.png" height="50px"/></div>
* TODO: Keycloak en qql mots
* Démarrer l'instance Keycloak:
<pre class="console">
docker-compose -f src/main/docker/keycloak up
</pre>
* vérifier en vous connectant sur http://(ip-keycloak)/
* identificant de connexion admin/admin

* Astuce: retrouver l'IP attribué par Docker:
<pre class="console">$ docker ps -q \
    | xargs docker inspect --format '{{ .Id }} \
    - {{ .Name }} - {{ .NetworkSettings.IPAddress }}'</pre>

---
# Lab2 - Définir de notre royaume de sécurité

* TODO: dessin représentant le royaume de sécurité
* capture d'écran FLD

---
# Lab2 - Tester la mise en place du royaume de sécurité

* connectez vous avec le user crée
* en admin faites expirer la session de cet utilisateur

---
# Lab2 - Mettre en place l'authentification à l'aide Keycloak

* git clone ... / tag
* modifier la configuration fournises dans application.properties pour fonctionner avec votre instance keycloak
* vérifier que l'accès au service /account requiert une authentification et que /ping reste accessible
* sur la partie admin de Keycloak invalider la session, de l'utilisateur utilisé et tester à nouveau l'accès à /account

<div class="aller-plus-loin">
<span class="aller-plus-loin-titre">Pour aller plus loin...</span>
<ul>
  <li>TODO</li>
</ul>
</div>

---
# Lab3 - Mise en place de Swagger
<div class="timer">10' <img src="img/chronometer.png" height="50px"/></div>

* Mettre en place d'une documentation en ligne pour notre API Rest avec <a href="https://springframework.guru/spring-boot-restful-api-documentation-with-swagger-2/">Swagger</a>
* Tester l'accès et le bon fonctionnement à la documentation: /swagger-ui.html

<div class="aller-plus-loin">
<span class="aller-plus-loin-titre">Pour aller plus loin...</span>
<ul>
  <li>TODO</li>
</ul>
</div>

---
# Lab4 - Mise en place d'un serveur inverse filtrant avec Nginx
<div class="timer">25' <img src="img/chronometer.png" height="50px"/></div>

* Prérequis: Construisez le container nginx :
<pre class="console">./src/main/docker/build-docker-image.sh</pre>
* Démarrer l'instance nginx:
<pre class="console">$ docker-compose -f src/main/docker/nginx.yml up</pre>
* Modifier la configuration fournises pour rediriger proprement vers votre service
(editer le fichier src/main/docker/nginx-config/basic-rp.conf)

---
# Lab4 - Mise en place d'un serveur inverse filtrant avec Nginx

* Tester avec curl http://(ip-du-conteneur)/ping
* Ajouter une redirection pour aussi "masquer" keycloak derrière ce proxy
* Modifier en conséquence la configuration de votre service et celle de Keycloak
* Interdir les requêtes POST, DELETE, HEAD et PUT en direction de /ping
* Configurer nginx pour nettoyer les requêtes vers /ping en retirant tout paramètres

<div class="aller-plus-loin">
<span class="aller-plus-loin-titre">Pour aller plus loin...</span>
<ul>
  <li>Limiter les requêtes vers Swagger au strict minimum requis:</li>
  <li>n'autoriser requêtes vers /swagger-ui* à part /swagger-ui.html, n'autoriser que les GET, retirer les arguments des requêtes...</li>
</ul>
</div>
---
# Lab5 - Mise en place du chiffrement SSL devant /ping et swagger
<div class="timer">20' <img src="img/chronometer.png" height="50px"/></div>

* git ... (tag)
* corriger la configuration fourni
* générer les certificats nécessaires et ajoute le volume associé
* tester que SSL fonctionne (https://localhost/)
* tester que /ping and /account sont toujours accessible via https
* incident: revoquer le certificat et le remplacer par un nouveau

* Documentation pour la <a href=" https://www.digitalocean.com/community/tutorials/how-to-create-a-self-signed-ssl-certificate-for-nginx-on-centos-7">génération des certificats et clés nécessaires</a>

---
# Pause
<div class="timer">10' <img src="img/chronometer.png" height="50px"/></div>

(ou continuer à geeker, bande de nerds)

---
# Lab6 - Intégration avec Spring Security
<div class="timer">15' <img src="img/chronometer.png" height="50px"/></div>

* Frameworking your way out of security...

.center[![Spring Security Logo](img/spring-security.logo.png)]

* (... because we can't gradle the shit out of it)

---
# Lab6 - Mise en place de Spring Security
* Ajouter Spring Security aux dépendances du projet
.center[![Spring Security Deps](img/springboot-security.png)]
* Ajouter la configuration d'un connecteur Keycloak pour Spring Security
.center[![Keycloak Adapter](img/keycloak-adapter-bom.png)]
* Migrer la configuration de KeyCloak du <span class="source-code">application.properties</span> dans une classe qui étend KeycloakWebSecurityConfigurerAdapter
* Tester et vérifier que l'intégration avec Keycloak fonctionne toujours sans encombre

* Ref: <a href="https://developers.redhat.com/blog/2017/05/25/easily-secure-your-spring-boot-applications-with-keycloak/">Spring Boot with Keycloak</a>

---
# Lab6 - CSRF et Cache control

* Vérifier le bon fonctionnement de l'API '/stuff' fournise (git clone [tag])
* Mettre en place la protection contre le <a href="https://docs.spring.io/spring-security/site/docs/current/reference/html/csrf.html">CSRF</a> et la <a href="https://docs.spring.io/spring-security/site/docs/current/reference/html/headers.html#headers-cache-control">gestion du cache</a> à l'aide de Spring Security
* Vérifier le bon fonctionnement de ces configurations à l'aide des requêtes curl suivante:
<pre class="console">
$ curl -v http://localhost:9091/stuff
$ curl -v -H "Content-Type: application/json" \
       -X POST -d '{"title":"un titre","text":"du texte"}' \
       http://localhost:9091/stuff
$ curl -v -H "Content-Type: application/json" \
       -X DELETE \
       -d '{"title":"un titre","text":"du texte"}' \
       http://localhost:9091/stuff
</pre>

---
# Lab6 - CSRF et Cache control

* Vérifier que les messages de retour sont cohérent avec les attentes:
<pre class="console">
{"timestamp":1523630530507,"status":403,
"error":"Forbidden", "message":"Could not
verify the provided CSRF token because your
session was not found.","path":"/stuff"}
</pre>

---
# Lab6 - CSRF et Cache control

* Vérifier la présence des nombreux entêtes de sécurité ajoutés par Spring Security:
<pre class="console">
Cache-Control: no-cache, no-store,
    max-age=0, must-revalidate
Pragma: no-cache
Expires: 0
X-Content-Type-Options: nosniff
Strict-Transport-Security:
    max-age=31536000 ; includeSubDomains
X-Frame-Options: DENY
X-XSS-Protection: 1; mode=block
</pre>

---
# Lab7 - Base de données
<div class="timer">20' <img src="img/chronometer.png" height="50px"/></div>
TODO:
* mise en place de MongoDB
* connexion sécurisée (SSL)
* chiffrement des données

---
# Lab7 - Le "Security Manager" (par configuration)

* Le Java Sécurity Manager en quelques mots... et un jolie (?) dessin

.center[![Java Security Manager Architecture](img/security-manager.png)]

---
# Lab8 - Le "Security Manager" (par configuration)
<div class="timer">25' <img src="img/chronometer.png" height="50px"/></div>

* Démarrer votre service en activant le système manager (sans configuration, "deny all")
<pre class="console"> $ java ... \
    -Djava.security.manager \
    -Djava.security.policy=file:///no.policy
</pre>
* Note: si le fichier no.policy n'existe pas (ou est vide), aucune autorisation donnée à l'applicatif!!!

---
# Lab8 - Le "Security Manager" (par configuration)

* Avec Spring Boot:
.center[![Java Security Manager + Spring Boot](img/springboot-with-secman.png)]

---
# Lab8 - Le "Security Manager" (par configuration)

* Modifier la configuration suivante pour permettre le démarrage du service avec le securité manager
<pre class="console">
<code>grant {
&nbsp;&nbsp;&nbsp;permission java.util.PropertyPermission  "*", "read, write";
&nbsp;&nbsp;&nbsp;permission java.util.PropertyPermission "java.awt.headless", "read";
&nbsp;&nbsp;&nbsp;permission java.io.FilePermission
&nbsp;&nbsp;&nbsp;&nbsp;"[path-to]/devoxx-france-lab-2018.git/danslecambouis", "read";
&nbsp;&nbsp;&nbsp;permission java.lang.reflect.ReflectPermission "*";
};</code></pre>

---
# Lab8 - Le "Security Manager" (version programmatique)

* "Ca marche pas!" et ça peut demander <a href="http://blog.sevagas.com/?Enable-securitymanager-for-Spring-and-Hibernate">beaucoup de boulot</a>.
* C'est l'enfer, hein? Bon faisons autrement... Créeons notre propre SecurityManager!
<pre class="source-code">
<code>public class PingSecurityManager extends SecurityManager {...}</code>
</pre>
* Et injecte le dans votre application:
<pre class="source-code">
<code>if ( System.getSecurityManager() == null )
&nbsp;&nbsp;&nbsp;&nbsp;System.setSecurityManager(new PingSecurityManager());</code></pre>
* Surcharger les méthodes <span class="source-code">checkPermission</span> (vide) pour autoriser l'app a accéder aux propriétés
* Surcharger la méthode <span class="source-code">checkAccept</span> pour autoriser le démarrage du serveur

---
# Lab8 - Le "Sécurity Manager" (version programmatique)

* Ajouter les méthodes nécessaires pour autoriser l'accès à la base de données

Pour aller plus loin...
* implémenter <span class="source-code">checkPermission</span> de manière à n'autoriser que les accès aux propriétés nécessaires

---
# Lab8 - Aller plus loin... SELinux

* SELinux en quelques mots... (<a href="https://access.redhat.com/documentation/en-us/red_hat_enterprise_linux/7/html/selinux_users_and_administrators_guide/index">Docs</a>)
.center[![](img/selinux-arch.png)]

* Tutorial SELinux (<a href="https://www.digitalocean.com/community/tutorials/an-introduction-to-selinux-on-centos-7-part-1-basic-concepts">Part 1</a> et <a href="https://www.digitalocean.com/community/tutorials/an-introduction-to-selinux-on-centos-7-part-2-files-and-processes">Part 2</a>)

* Objectif: Créer un utilisateur 'pingservice' appartenant au group 'microservices'
confiner à /ping (volume monté, mappé sur la racine du projet)

---
# Lab8 -  Aller plus loin... SELinux

* Modifier l'utilisateur pour l'associer au service:
<pre class="console">$ semanage login -a -s user_u pingservice</pre>
---
# Lab9 - Pour aller plus loin...
<div class="timer">30' <img src="img/chronometer.png" height="50px"/></div>

* Implémenter un fichier de journalisation qui loggue chaque appel à '/ping'
* Adapter la configuration du SecurityManager et de SELinux pour autoriser l'accès en écriture au fichier de journalisation (/var/log/microservice/ping.log)
* Potentiellement, une attaque peut changer le contenu du fichier de journalisation - sans que SELinux et le Security Manager n'interviennent...
* Concevez et implémenter un mécanimse pour assurer que le contenu du fichier ne puisse pas être compromis

---
# Conclusion

* It was fun! (we hope)
* You learn stuff! (we hope)
* Your laptop still works (hopefully)
    </textarea>
    <script src="https://remarkjs.com/downloads/remark-latest.min.js">
    </script>
    <script>
      var slideshow = remark.create();
    </script>
  </body>
</html>
